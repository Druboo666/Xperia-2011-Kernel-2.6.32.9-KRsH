#!/sbin/sh
setprop service.adb.root 1
if [ -e /sbin/bootrec-device ]
then
  /sbin/bootrec-device
fi

# let's force adb mode on startup, because AOSP/CM10 are stupid and disable it by default
echo 0 > /sys/class/android_usb/android0/enable
echo 0fce > /sys/class/android_usb/android0/idVendor 
echo 614f > /sys/class/android_usb/android0/idProduct
echo "mass_storage,adb" > /sys/class/android_usb/android0/functions
echo 1 > /sys/class/android_usb/android0/enable
stop adbd

# fix framebuffer for recovery
echo 0 > /sys/module/msm_fb/parameters/align_buffer

if [ -e /cache/recovery/boot -o -s /dev/keycheck ]
then
  mount -o remount,rw rootfs /
  umount -l /system
  umount -l /data
  umount -l /mnt/sdcard
  umount -l /sdcard
  rm -r /sdcard
  rm -r /mnt/sdcard
  mkdir /sdcard
  mkdir /tmp
  rm /etc
  mkdir /etc
  #umount -l /cache
  mount /dev/block/mmcblk0p1 /sdcard
  chmod 755 /res/aromapreinstall/aroma-installer
  chmod 755 /res/aromapreinstall/*.sh
  /res/aromapreinstall/aroma-installer 1 0 "/res/aromapreinstall/aroma-installer-res.zip"
  #touch /tmp/bootrec
fi

if [ -e /tmp/bootrec ]
then
  rm /cache/recovery/boot
  rm /tmp/bootrec
  umount -l /cache
  mount /dev/block/mmcblk0p1 /sdcard
  /sbin/recovery&/sbin/adbd
fi
    
# Couldn't be bothered doing this in init syntax (I'm ignorant) so we'll link dalvik here instead
mkdir /data/dalvik-cache
    chown system:system /data/dalvik-cache
    chmod 0771 /data/dalvik-cache
ln -s /data/dalvik-cache /cache/dalvik-cache
    chown system:system /cache/dalvik-cache
    chmod 0771 /cache/dalvik-cache

# restore framebuffer for JB
echo 1 > /sys/module/msm_fb/parameters/align_buffer
    
#continue booting



